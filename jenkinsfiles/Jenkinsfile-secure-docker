pipeline {
    agent any
    options {
        skipDefaultCheckout(true)
    }
    
    environment {
        LIQUIBASE_COMMAND_USERNAME = credentials('LIQUIBASE_USER')
        LIQUIBASE_COMMAND_PASSWORD = credentials('LIQUIBASE_PASSWORD')
        LIQUIBASE_LICENSE_KEY = credentials('LIQUIBASE_KEY')
        LIQUIBASE_DEFAULTS_FILE="liquibase.linux.properties"
        ENVIRONMENT = "${params.ENVIRONMENT}"
        
        AWS_S3_BUCKET = credentials('AWS_S3_BUCKET')
        AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
        AWS_REGION = "us-east-1"
    }
        
    stages {
        stage('Workspace') {
            steps {
                script {
                    currentBuild.displayName = "#" + env.BUILD_NUMBER + " ${ENVIRONMENT}"
                }
                
                cleanWs()
                checkout scm
                echo "Building ${env.JOB_NAME}..."
            }
        }
		
		stage('Debug Credentials') {
			steps {
				sh 'echo "License key length: ${#LIQUIBASE_LICENSE_KEY}"'
				sh 'echo "First 12 chars: ${LIQUIBASE_LICENSE_KEY:0:12}"'
			}
		}
        
        stage('Running Liquibase') {
            steps {
                sh '''
                    docker run --rm \
                        -v ${WORKSPACE}:/liquibase/changelog \
                        -e LIQUIBASE_COMMAND_USERNAME="${LIQUIBASE_COMMAND_USERNAME}" \
                        -e LIQUIBASE_COMMAND_PASSWORD="${LIQUIBASE_COMMAND_PASSWORD}" \
                        -e LIQUIBASE_LICENSE_KEY="${LIQUIBASE_LICENSE_KEY}" \
                        -e LIQUIBASE_DEFAULTS_FILE="${LIQUIBASE_DEFAULTS_FILE}" \
                        liquibase/liquibase-secure:latest \
                        liquibase -v
                '''
            }
        }
    }
}